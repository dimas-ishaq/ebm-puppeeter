const puppeteer=require("puppeteer-extra"),fs=require("fs"),path=require("path"),StealthPlugin=require("puppeteer-extra-plugin-stealth"),anonymizeUA=require("puppeteer-extra-plugin-anonymize-ua"),{PNG:PNG}=require("pngjs"),resizeImg=require("resize-img"),os=require("os"),ssim=require("ssim.js").default;puppeteer.use(anonymizeUA()),puppeteer.use(StealthPlugin());const cookieFile=path.resolve("cookie.txt"),targetUrl="https://earnbitmoon.club/",delay=e=>new Promise((a=>setTimeout(a,e)));async function checkAndRedirect(e){let a=0;for(;a<5;){a++;try{const t=await e.url();t!==targetUrl&&(console.log(`🔄 Percobaan ${a}: URL saat ini ${t}. Mengalihkan ke ${targetUrl}...`),await e.goto(targetUrl,{waitUntil:"networkidle0",timeout:6e4}),console.log(`✅ Berhasil diarahkan ke ${targetUrl}`));break}catch(e){const a=e.message||"";if(console.log(`⚠️ Terjadi kesalahan saat pengecekan URL: ${a}`),!a.includes("net::ERR_CONNECTION_TIMED_OUT"))break;console.log("🔁 Koneksi timeout, mencoba lagi dalam 5 detik..."),await new Promise((e=>setTimeout(e,5e3)))}}}async function isLoggedIn(e){await checkAndRedirect(e);try{return await e.waitForSelector("div.info span.logout",{timeout:2e4}),!0}catch{return!1}}function cropImage(e,a,t,i,o){const n=new PNG({width:i,height:o});return PNG.bitblt(e,n,a,t,i,o,0,0),n}function addBackgroundToRight(e,a,t=5){const i=e.width+t,o=new PNG({width:i,height:e.height});for(let e=0;e<o.height;e++)for(let t=0;t<o.width;t++){const i=o.width*e+t<<2;o.data[i]=a.r,o.data[i+1]=a.g,o.data[i+2]=a.b,o.data[i+3]=255}return PNG.bitblt(e,o,0,0,e.width,e.height,0,0),o}function addBackgroundToLeft(e,a,t=5){const i=e.width+t,o=new PNG({width:i,height:e.height});for(let i=0;i<o.height;i++)for(let n=0;n<o.width;n++){const l=o.width*i+n<<2;if(n<t)o.data[l]=a.r,o.data[l+1]=a.g,o.data[l+2]=a.b,o.data[l+3]=255;else{const a=n-t+e.width*i<<2;o.data[l]=e.data[a],o.data[l+1]=e.data[a+1],o.data[l+2]=e.data[a+2],o.data[l+3]=e.data[a+3]}}return o}function detectBorders(e,a,t){const i=[];for(let o=0;o<e.width;o++){let n=0;for(let t=0;t<e.height;t++){const i=e.width*t+o<<2,[l,r,s]=[e.data[i],e.data[i+1],e.data[i+2]];l<=a.r&&r<=a.g&&s<=a.b&&n++}n/e.height>t&&(0===i.length||o-i.at(-1)>2)&&i.push(o)}return i}async function compareImages(e,a){const t=PNG.sync.read(fs.readFileSync(e)),i=PNG.sync.read(fs.readFileSync(a)),{mssim:o}=ssim({data:t.data,width:t.width,height:t.height},{data:i.data,width:i.width,height:i.height});return o}async function safeGoto(e,a,t=5){for(let i=1;i<=t;i++)try{return void await e.goto(a,{waitUntil:"networkidle0",timeout:6e4})}catch(e){if(console.log(`⏳ Retry (${i}/${t}):`,e.message),i===t)throw e;await delay(5e3)}}async function safeReload(e,a={waitUntil:"networkidle0",timeout:3e4},t=10){let i=0;for(;i<t;)try{return await e.reload(a),console.log(`✅ Berhasil reload halaman pada percobaan ke-${i+1}.`),!0}catch(e){i++,console.log(`❌ Percobaan ke-${i} gagal reload: ${e.message}`),i<t&&(console.log("🔁 Mencoba ulang dalam 5 detik..."),await delay(5e3))}return console.log(`🛑 Gagal reload setelah ${t} kali percobaan.`),!1}async function saveCookiesHeader(e){const a=(await e.cookies()).map((e=>`${e.name}=${e.value}`)).join("; ");fs.writeFileSync(cookieFile,a,"utf-8"),console.log("✅ Cookie disimpan ulang ke cookie.txt")}async function claimFaucet(e){if(await isLoggedIn(e)){console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ✅ Login berhasil, mulai proses klaim`);try{console.log("🕵️ Mencari tombol klaim..."),await e.waitForSelector("div#claimFaucet button[data-toggle=modal]",{visible:!0}),await e.click("div#claimFaucet button[data-toggle=modal]"),await delay(1e3),await e.click("div.iconcaptcha-modal__body"),await delay(2e3),await e.waitForSelector(".iconcaptcha-modal__body-icons",{visible:!0}),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 📸 Mengambil screenshot captcha...`);const a=await e.$("div.iconcaptcha-modal__body-selection"),t=await a.boundingBox(),i=await a.screenshot({encoding:"binary"});fs.writeFileSync("icon.png",i),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ✂️ Memproses gambar captcha...`);const o=PNG.sync.read(i);fs.writeFileSync("before-icon.png",PNG.sync.write(o));const n=addBackgroundToRight(o,{r:76,g:76,b:76},5),l=PNG.sync.write(n);fs.writeFileSync("addbgright.png",l);const r=fs.readFileSync("addbgright.png"),s=addBackgroundToLeft(PNG.sync.read(r),{r:76,g:76,b:76},5),c=PNG.sync.write(s);fs.writeFileSync("addbgleft.png",c);const g=PNG.sync.read(fs.readFileSync("addbgleft.png")),d=[0,...detectBorders(g,{r:75,g:75,b:75},.9),g.width],w=d.slice(0,-1).map(((e,a)=>{const t=d[a+1]-e,i=new PNG({width:t,height:g.height});return PNG.bitblt(g,i,e,0,t,g.height,0,0),i}));console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🔍 Ditemukan ${w.length} icon .`);const m=path.join(os.tmpdir(),"icon-comparison");fs.existsSync(m)||fs.mkdirSync(m),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 📏 Resize & bandingkan gambar...`);const u=await Promise.all(w.map((async(e,a)=>{const t=PNG.sync.write(e),i=await resizeImg(t,{width:64,height:64}),o=path.join(m,`icon_${a}.png`);return fs.writeFileSync(o,i),o}))),h=await Promise.all(u.map((async(e,a)=>{const t=await u.reduce((async(t,i,o)=>{if(a===o)return t;const n=await compareImages(e,i);return await t+n}),Promise.resolve(0));return console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 📊 Total SSIM untuk icon_${a}.png: ${t.toFixed(4)}`),{index:a,totalScore:t}})));h.sort(((e,a)=>e.totalScore-a.totalScore));const p=h[0].index;console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🎯 Gambar terpilih: index ke-${p}`);const b=d[p],f=d[p+1]-b,y=t.x+b+f/2,k=t.y+t.height/2;await e.mouse.click(y,k),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🖱️ Klik captcha di posisi X=${y.toFixed(2)}, Y=${k.toFixed(2)}`),await e.waitForSelector("button.zxz"),await delay(8e3),await e.click("button.zxz");const S=await e.screenshot({encoding:"binary"});fs.writeFileSync("claim.png",S);try{const a=await e.screenshot({encoding:"binary"});fs.writeFileSync("claim2.png",a),await delay(5e3),await e.reload({waitUntil:"networkidle0",timeout:6e4});const t=await e.$eval("#sidebarCoins",(e=>e.innerText.trim())),i=await e.$eval('a[href="/rewards.html"] > b',(e=>e.innerText.trim()));await e.waitForSelector("#claimTime",{visible:!0,timeout:6e4});const o=await e.$eval("#claimTime",(e=>e.innerText.trim()));if(""===o)throw console.log(`🕒 ${(new Date).toLocaleTimeString()} - ❌ Gagal klaim, pesan: "", mencoba ulang...`),new Error("Klaim tidak berhasil");console.log(`🕒 ${(new Date).toLocaleTimeString()} - 🎉 ${o} - 💰 ${t} - 📈 ${i}`),console.log("🕒 Menunggu 5 menit sebelum klaim kembali...")}catch(a){const t=await e.screenshot({encoding:"binary"});throw fs.writeFileSync("claim3.png",t),console.log(`⚠️ Gagal klaim: ${a.message}`),a}}catch(e){throw console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ⚠️ Gagal klaim:`,e.message),e}}else console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ❌ Cookie tidak valid atau belum login`)}async function runClaim(){let e=0,a=!1;const t=await puppeteer.launch({headless:!0,executablePath:"/usr/bin/chromium",ignoreHTTPSErrors:!0,args:["--no-sandbox","--disable-gpu","--ignore-certificate-errors","--disable-dev-shm-usage","--disable-setuid-sandbox","--no-zygote","--disable-accelerated-2d-canvas","--disable-background-networking","--disable-background-timer-throttling","--disable-client-side-phishing-detection","--disable-popup-blocking","--disable-default-apps","--mute-audio","--disable-extensions","--disable-software-rasterizer","--disable-logging","--disable-features=IsolateOrigins,site-per-process","--disable-device-discovery-notifications","--disable-plugins","--remote-debugging-port=0","--disable-sync","--disable-web-security","--headless","--disable-background-tasks","--single-process"]}),i=await t.newPage();await i.setViewport({width:414,height:896}),console.clear(),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🌐 Membuka halaman...`);const o=fs.readFileSync("user-agent.txt","utf8").trim();if(await i.setUserAgent(o),await i.setExtraHTTPHeaders({accept:"*/*","accept-language":"en-US,en;q=0.9",referer:targetUrl}),fs.existsSync(cookieFile)){console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🍪 Memuat cookie dari file...`);const e=fs.readFileSync(cookieFile,"utf-8").trim().split(";").map((e=>{const[a,...t]=e.trim().split("=");return{name:a,value:t.join("="),domain:"earnbitmoon.club",path:"/",httpOnly:!1,secure:!1}}));await i.setCookie(...e)}for(await safeGoto(i,targetUrl),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ✅ Halaman dimuat`);e<10;){if(console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ⏳ Percobaan login ke-${e+1}...`),a=await isLoggedIn(i),a){console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ✅ Login berhasil!`);break}e++,console.log(`🕒 ${(new Date).toLocaleTimeString()} -- ❌ Login gagal pada percobaan ke-${e}`),e>=10&&(console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🚨 Login gagal setelah 10 percobaan. Kode dihentikan.`),await t.close(),process.exit(0)),await new Promise((e=>setTimeout(e,5e3)))}await claimFaucet(i),await saveCookiesHeader(i),await t.close()}(async()=>{for(;;)try{await runClaim(),console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 💤 Browser ditutup, tidur 5 menit...`),await delay(295e3)}catch(e){console.log(`🕒 ${(new Date).toLocaleTimeString()} -- 🔄 Terjadi kesalahan: ${e.message}. Mengulangi proses klaim dalam 15 detik...`),await delay(15e3)}})();
